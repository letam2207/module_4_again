<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh sách sản phẩm</title>
    <th:block th:replace="~{common/template::library}"></th:block>
</head>
<body>

<div class="container mt-4">
    <h2 class="text-center mb-3 text-primary"> Danh sách sản phẩm</h2>

    <form th:action="@{/product}" method="get" class="row g-2 mb-3">
        <div class="col-md-6">
            <input type="text" name="name" th:value="${search}" class="form-control"
                   placeholder="Nhập tên sản phẩm cần tìm...">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
        </div>
        <div class="col-md-4 text-end">
            <button type="button" class="btn btn-danger me-2" id="btnDeleteAll" onclick="openDeleteModal()" disabled>
                Xóa đã chọn
            </button>
            <a th:href="@{/product/create}" class="btn btn-success"> Thêm mới</a>
        </div>
    </form>

    <p id="message" class="text-success fw-bold text-center" th:text="${message}"></p>

    <form th:action="@{/product/delete-all}" method="post" id="formDeleteAll">
        <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-dark">
            <tr>
                <th>STT</th>
                <th>Chọn</th>
                <th>Tên sản phẩm</th>
                <th>Giá</th>
                <th>Trạng thái</th>
                <th>Loại sản phẩm</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="product ,status : ${productPage.content}">
                <td th:text="${status.count}"></td>
                <td>
                    <input type="checkbox" name="ids"
                           th:value="${product.id}"
                           th:data-name="${product.name}"
                           onclick="checkBtnDelete()">
                </td>
                <td th:text="${product.name}"></td>
                <td th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA')}"></td>
                <td th:text="${product.status}"></td>
                <td th:text="${product.productType != null ? product.productType.nameType : 'N/A'}"></td>
            </tr>

            <tr th:if="${productPage.totalElements == 0}">
                <td colspan="6" class="text-muted">Không tìm thấy sản phẩm nào</td>
            </tr>
            </tbody>
        </table>
    </form>

    <div class="d-flex justify-content-center mt-3" th:if="${productPage.totalPages > 0}">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item" th:classappend="${!productPage.hasPrevious()} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/product(page=${productPage.number - 1}, name=${search})}">
                        &laquo; Trước
                    </a>
                </li>
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(0, productPage.totalPages - 1)}"
                    th:classappend="${productPage.number == i} ? 'active'">
                    <a class="page-link"
                       th:href="@{/product(page=${i}, name=${search})}"
                       th:text="${i + 1}">
                    </a>
                </li>
                <li class="page-item" th:classappend="${!productPage.hasNext()} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/product(page=${productPage.number + 1}, name=${search})}">
                        Sau &raquo;
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="deleteModalLabel"> Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa <span id="countDelete" class="fw-bold text-primary">0</span> sản phẩm này không?</p>

                <div class="border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto;">
                    <ul id="productListModal" class="list-group list-group-flush text-start small mb-0">
                    </ul>
                </div>

                <p class="mt-3 text-danger mb-0"><small>Hành động này không thể hoàn tác!</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Xóa ngay</button>
            </div>
        </div>
    </div>
</div>

<script>
    setTimeout(() => {
        const m = document.getElementById("message");
        if (m) m.style.display = "none";
    }, 3000);

    function toggleAll(source) {
        let checkboxes = document.getElementsByName('ids');
        for (let i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
        checkBtnDelete();
    }

    function checkBtnDelete() {
        let checkboxes = document.getElementsByName('ids');
        let btnDelete = document.getElementById('btnDeleteAll');
        let checkedCount = 0;

        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                checkedCount++;
            }
        }
        btnDelete.disabled = checkedCount === 0;
    }


    function openDeleteModal() {
        let checkboxes = document.getElementsByName('ids');
        let productListModal = document.getElementById("productListModal");
        let countSpan = document.getElementById("countDelete");

        productListModal.innerHTML = "";
        let count = 0;

        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                count++;

                let productName = checkboxes[i].getAttribute("data-name");

                let li = document.createElement("li");
                li.className = "list-group-item bg-transparent py-1 border-0 border-bottom";
                li.innerText = count + ". " + productName;
                productListModal.appendChild(li);
            }
        }

        countSpan.innerText = count;

        const myModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        myModal.show();
    }

    function confirmDelete() {
        document.getElementById("formDeleteAll").submit();
    }
</script>

</body>
</html>